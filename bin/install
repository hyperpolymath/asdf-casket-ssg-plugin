#!/usr/bin/env bash
# SPDX-License-Identifier: PMPL-1.0-or-later
# Copyright (c) 2024 hyperpolymath
# asdf-casket-ssg: Install casket-ssg to ASDF_INSTALL_PATH

set -euo pipefail

# Get the plugin directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source utility functions
# shellcheck source=lib/utils.bash
source "${PLUGIN_DIR}/lib/utils.bash"

# Environment variables provided by asdf
# ASDF_INSTALL_TYPE: "version" or "ref"
# ASDF_INSTALL_VERSION: the version number or git ref
# ASDF_INSTALL_PATH: where to install the tool
# ASDF_DOWNLOAD_PATH: where the source/binary was downloaded (if bin/download exists)
# ASDF_CONCURRENCY: number of cores to use for compilation

install_casket_ssg() {
  local install_type="${ASDF_INSTALL_TYPE:-version}"
  local version="${ASDF_INSTALL_VERSION:-}"
  local install_path="${ASDF_INSTALL_PATH:-}"
  local download_path="${ASDF_DOWNLOAD_PATH:-}"

  if [[ -z "${version}" ]]; then
    fail "ASDF_INSTALL_VERSION is required"
  fi

  if [[ -z "${install_path}" ]]; then
    fail "ASDF_INSTALL_PATH is required"
  fi

  if [[ "${install_type}" != "version" ]]; then
    fail "asdf-casket-ssg only supports version installs, not refs"
  fi

  log_info "Installing casket-ssg ${version}..."

  # If download_path is not set or empty, download here (for older asdf versions)
  if [[ -z "${download_path}" ]] || [[ ! -d "${download_path}" ]]; then
    download_path="${install_path}/tmp_download"
    mkdir -p "${download_path}"

    log_info "Downloading casket-ssg ${version}..."
    local download_url archive_file
    download_url="$(get_download_url "${version}")"
    archive_file="${download_path}/casket-ssg.tar.gz"

    download_file "${download_url}" "${archive_file}" || fail "Failed to download casket-ssg ${version}"
    tar -xzf "${archive_file}" -C "${download_path}" --strip-components=1 || fail "Failed to extract archive"
    rm -f "${archive_file}"
  fi

  # Create the install directory
  mkdir -p "${install_path}/bin"

  # Copy the binary
  log_info "Copying files to ${install_path}..."

  if [[ -f "${download_path}/casket-ssg" ]]; then
    cp "${download_path}/casket-ssg" "${install_path}/bin/"
    chmod +x "${install_path}/bin/casket-ssg"
  elif [[ -d "${download_path}/bin" ]]; then
    cp -r "${download_path}/bin"/* "${install_path}/bin/"
    chmod +x "${install_path}/bin"/*
  else
    fail "Could not find casket-ssg binary in download"
  fi

  # Copy documentation if present
  cp "${download_path}/README.adoc" "${install_path}/" 2>/dev/null || true
  cp "${download_path}/README.md" "${install_path}/" 2>/dev/null || true
  cp "${download_path}/LICENSE" "${install_path}/" 2>/dev/null || true

  # Clean up temp download if we created it
  if [[ -d "${install_path}/tmp_download" ]]; then
    rm -rf "${install_path}/tmp_download"
  fi

  # Verify installation
  local casket_path="${install_path}/bin/casket-ssg"

  if [[ ! -x "${casket_path}" ]]; then
    fail "Installation failed: casket-ssg not found in ${install_path}/bin"
  fi

  log_success "casket-ssg ${version} installed successfully to ${install_path}"

  # Show version info
  log_info "Installed version:"
  "${install_path}/bin/casket-ssg" --version 2>&1 | head -1 || "${install_path}/bin/casket-ssg" 2>&1 | head -1 || true
}

# Main
check_dependencies
install_casket_ssg
